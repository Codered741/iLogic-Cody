'Collect, Zip?, and Attach DXF's to Drawing
Imports System.IO
Imports System.IO.Path
Imports System.Collections
Imports My.Computer.FileSystem

Sub Main()

	Dim oDoc as Document = ThisApplication.ActiveDocument
	If Not isDwg(oDoc) Then
		MsgBox("Please run from a Drawing file.  ")
		Exit Sub
	End If
	

	Dim collectFolder As String = FilePath(oDoc.FullFileName) & BaseFilename(oDoc.FullFileName) & " DXF\"
	
	Dim oAppend As System.IO.StreamWriter
	Dim oFile As String = "C:\-"
	
	Try
		oAppend = IO.File.AppendText(oFile)
	Catch
		noWrite = True
	End Try
	
	Dim oRefDocs as DocumentsEnumerator = oDoc.AllReferencedDocuments
	Dim copiedFileName As String
	
	For Each oRefDoc in oRefDocs
		
		Dim iProps as PropertySet = oRefDoc.PropertySets.Item("Design Tracking Properties")
		Dim RefPN = iProps.Item("Part Number")
		RefPath = FilePath(oRefDoc.FullFileName)
		RefFileName = BaseFilename(oRefDoc.FullFileName)
		
		'look for files with the same file name as ref doc
		FileNameDXF = RefPath & RefFileName & ".dxf"
		If System.IO.File.Exists(FileNameDXF) Then 'search for single page drawings
			copiedFileName = collectFolder & RefFileName & ".dxf"
			System.IO.Directory.CreateDirectory(collectFolder)
			My.Computer.FileSystem.CopyFile(FileNameDXF, copiedFileName)
		End If

		For i = 1 to 10 'search for pages 1-10
			FileNameDXF = FilePath(FindDrawingFile(oRefDoc)) & RefPN.Value & " p" & i & ".dxf"
			If System.IO.File.Exists(FileNameDXF) Then
				copiedFileName = collectFolder & BaseFilename(FileNameDXF) & " p" & i & ".dxf"
				System.IO.Directory.CreateDirectory(collectFolder)
				My.Computer.FileSystem.CopyFile(FileNameDXF, copiedFileName)
			End If
		Next 
		
		For i = 1 to 10 'search for pages 1-10 by part number
			FileNameDXF = FilePath(FindDrawingFileRefPN(oRefDoc)) & RefPN.Value & " p" & i & ".dxf"
			If System.IO.File.Exists(FileNameDXF) Then
				copiedFileName = collectFolder & BaseFilename(FileNameDXF) & " p" & i & ".dxf"
				System.IO.Directory.CreateDirectory(collectFolder)
				My.Computer.FileSystem.CopyFile(FileNameDXF, copiedFileName)
			End If
		Next 
		
	Next
	
	If System.IO.Directory.Exists(collectFolder) Then
		Process.Start(collectFolder)
	End If
	
End Sub

Function FindDrawingFile(PartOrAssemblyDoc As Document)
    Dim fullFilename As String
    fullFilename = PartOrAssemblyDoc.fullFilename
   
    ' Extract the path from the full filename.
    Dim path As String
    path = Left$(fullFilename, InStrRev(fullFilename, "\"))
   
    ' Extract the filename from the full filename.
    Dim filename As String
    filename = Right$(fullFilename, Len(fullFilename) - InStrRev(fullFilename, "\"))
   
    ' Replace the extension with "dwg"
    filename = Left$(filename, InStrRev(filename, ".")) & "dwg"
   
    ' Find if the drawing exists.
    Dim drawingFilename As String
    drawingFilename = ThisApplication.DesignProjectManager.ResolveFile(path, filename)
   
    ' Check the result.
    If drawingFilename = "" Then
        ' Try again with idw extension.
        filename = Left$(filename, InStrRev(filename, ".")) & "idw"
       
        ' Find if the drawing exists.
        drawingFilename = ThisApplication.DesignProjectManager.ResolveFile(path, filename)
   
        ' Return the result.
        If drawingFilename <> "" Then
            FindDrawingFile = drawingFilename
        Else
            FindDrawingFile = ""
        End If
    Else
        ' Return the result.
        FindDrawingFile = drawingFilename
    End If
End Function

Function FindDrawingFilePN(PartOrAssemblyDoc As Document)
    Dim fullFilenamePN As String
    fullFilenamePN = PartOrAssemblyDoc.fullFilename
   
    ' Extract the path from the full filename.
    Dim path As String = "C:\_vaultWIP\Designs"
    'path = Left$(fullFilenamePN, InStrRev(fullFilenamePN, "\"))
   
	Dim iProps as PropertySet = PartOrAssemblyDoc.PropertySets.Item("Design Tracking Properties")
	Dim pn = iProps.Item("Part Number")
	
    Dim filename As String = pn.Value
    'filename = Right$(fullFilenamePN, Len(fullFilenamePN) - InStrRev(fullFilenamePN, "\"))
   
    ' Replace the extension with "dwg"
    filename = filename & ".dwg"
   
    ' Find if the drawing exists.
    Dim drawingFilename As String
    drawingFilename = ThisApplication.DesignProjectManager.ResolveFile(path, filename)
   
    ' Check the result.
    If drawingFilename = "" Then
        ' Try again with idw extension.
        filename = filename & "idw"
       
        ' Find if the drawing exists.
        drawingFilename = ThisApplication.DesignProjectManager.ResolveFile(path, filename)
   
        ' Return the result.
        If drawingFilename <> "" Then
            Return drawingFilename
        Else
            Return ""
        End If
    Else
        ' Return the result.
         Return drawingFilename
    End If
End Function

Function isDwg(ThisDoc as Document) As Boolean
	Debug.Print (ThisDoc.DocumentType)
	If ThisDoc.DocumentType = kDrawingDocumentObject
		isDwg = True
	Else 
		isDwg = False
	End If
End Function

Function DocumentFileName(Doc As Document) As String
	Dim FilePath as String
	FilePath = Doc.FullFileName
	DocumentFileName = IO.Path.GetFileNameWithoutExtension(FilePath)
	'MsgBox(DocumentFileName)
End Function

Function BaseFilename(ByVal fullFilename As String) As String
    Dim temp As String
    temp = Right(fullFilename, Len(fullFilename) - InStrRev(fullFilename, "\"))
    BaseFilename = Left(temp, InStrRev(temp, ".") - 1)
End Function

Function FilePath(ByVal fullFilename As String) As String
    FilePath = Left(fullFilename, InStrRev(fullFilename, "\"))
End Function